<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard - Princess Angel Salon</title>
  <link rel="stylesheet" href="registered-dashboard.css" />
    <style>
    /* Improved styles for searchable multi-select used for services */
    .multi-select { position: relative; max-width:380px; width:100%; box-sizing:border-box; margin:0.25rem 0 1rem 0; }
    .ms-control { width:100%; text-align:left; padding:10px 12px; border:1px solid #e4a7b6; border-radius:6px; background:#fff; cursor:pointer; color:#333; font-weight:500; }
    .ms-control:after { content:'\25BE'; float:right; color:#d64f6e; }
  .ms-dropdown { position:absolute; left:0; right:0; background:#fff; border:1px solid rgba(214,79,110,0.15); border-radius:8px; margin-top:8px; box-shadow:0 10px 30px rgba(0,0,0,0.08); z-index:9999; display:none; }
    .ms-dropdown.show { display:block; }
    .ms-search { width:calc(100% - 16px); margin:10px; padding:8px; border:1px solid #f0d7dd; border-radius:6px; }
    .ms-items { max-height:260px; overflow:auto; padding:6px 8px 12px 8px; }
    .ms-item { padding:8px 6px; display:flex; align-items:center; gap:12px; justify-content:space-between; border-bottom:1px solid #faf0f2; }
    .ms-item:last-child { border-bottom:0; }
    .ms-item .left { display:flex; align-items:center; gap:10px; }
    .ms-item .name { font-weight:500; color:#333; }
    .ms-item .meta { color:#888; font-size:0.9rem; white-space:nowrap; }
    .ms-item label { cursor:pointer; display:flex; align-items:center; gap:8px; }
    /* Small adjustments for checkbox visuals */
    .ms-item input[type="checkbox"] { transform:scale(1.05); }
    /* Ensure control and dropdown match form spacing */
  #book-form .ms-control, #book-form select, #book-form input { max-width:380px; }
  /* Ensure booking card doesn't clip dropdown */
  section.home-section { overflow: visible; }
  </style>
</head>
<body>
<header class="header-nav">
  <div class="nav-container">
    <!-- Left: Title -->
    <div class="logo">
      <h1 id="welcome-text">Welcome!</h1>
    </div>

    <!-- Right: Hamburger -->
    <button class="hamburger" id="hamburger" aria-label="Open menu" aria-controls="sideNav" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>

  <!-- Sidebar Navigation (Right side) -->
  <nav id="sideNav" class="side-nav" aria-hidden="true">
    <div class="side-nav-inner">
      <button class="close-side" id="closeSide" aria-label="Close menu">&times;</button>
      <ul class="side-links">
        <li><a href="#dashboard-summary">Dashboard</a></li>
        <li><a href="#appointments">My Appointments</a></li>
        <li><a href="#book">Book Appointment</a></li>
        <!--<li><a href="#favorite-stylists">Favorite Stylists</a></li>-->
        <li><a href="#profile">Profile</a></li>
        <li><a href="#feedback">Feedback</a></li>
        <li><a href="#notifications">Notifications</a></li>
        <li><a href="#help">Help</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Backdrop -->
  <div class="backdrop" id="backdrop"></div>
</header>



  <!-- Dashboard Summary -->
  <section id="dashboard-summary" class="home-section">
    <h2>Dashboard Summary</h2>
    <div class="summary-cards">
      <div class="card">Upcoming: <span id="upcoming-count">0</span></div>
      <div class="card">Completed: <span id="completed-count">0</span></div>
      <div class="card">Canceled: <span id="canceled-count">0</span></div>
    <!-- <div class="card">Favorite Stylist: <span id="favorite-stylist">-</span></div>--> 
    </div>
  </section>

  <!-- Appointments -->
  <section id="appointments" class="home-section">
    <h2>My Appointments</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Service</th>
          <th>Stylist</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="appointments-table"></tbody>
    </table>
  </section>

  <div id="reschedule-modal" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:1rem; border:1px solid #ccc; box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:999;">
    <h3>Reschedule Appointment</h3>
    <label>Date:</label>
    <input type="date" id="reschedule-date" />
    <label>Time:</label>
    <input type="time" id="reschedule-time" />
    <br/><br/>
    <button onclick="confirmReschedule()">Confirm</button>
    <button onclick="closeRescheduleModal()">Cancel</button>
  </div>

  <!-- Booking History -->
  <section id="booking-history" class="home-section">
    <h2>Booking History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>Service</th>
          <th>Stylist</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="booking-history-table">
        <!-- dynamically loaded completed appointments -->
      </tbody>
    </table>
  </section>  

  
  <!-- Book Appointment -->
  <section id="book" class="home-section">
    <h2>Book an Appointment</h2>
    <form id="book-form">
      <label>Services (choose one or more):</label>
      <!-- Custom searchable multi-select for services (behaves like the stylist select) -->
      <div id="services-list" class="multi-select">
        <button type="button" class="ms-control" aria-haspopup="listbox" aria-expanded="false">Select services</button>
        <div class="ms-dropdown" role="listbox" aria-hidden="true">
          <input type="search" class="ms-search" placeholder="Filter services..." aria-label="Filter services" />
          <div class="ms-items" tabindex="0">
            <p style="color:#666; font-size:0.9rem;">Loading services...</p>
          </div>
        </div>
      </div>

      <label>Stylist:</label>
      <select id="stylist" required>
        <option value="">Loading stylists...</option>
      </select>

      <label>Date:</label>
      <input type="date" id="date" required />

      <label>Time:</label>
      <input type="time" id="time" required />

      <button type="submit">Book Appointment</button>
    </form>
  </section>

  <!-- Favorite Stylists
  <section id="favorite-stylists" class="home-section">
    <h2>Favorite Stylists</h2>
    <ul id="favorite-stylist-list">
       dynamically loaded favorite stylists 
    </ul>
  </section>-->

  <!-- Profile -->
  <section id="profile" class="home-section">
    <h2>My Profile</h2>
    <form id="profile-form">
      <label for="name">Full Name:</label>
      <input type="text" id="name" />

      <label for="email">Email:</label>
      <input type="email" id="email" />

      <label for="phone">Phone:</label>
      <input type="tel" id="phone" />

      <button type="submit">Update Profile</button>
    </form>

    <h3>Change Password</h3>
    <form id="password-form">
      <label for="current-password">Current Password:</label>
      <input type="password" id="current-password" required />

      <label for="new-password">New Password:</label>
      <input type="password" id="new-password" required />

      <button type="submit">Change Password</button>
    </form>
  </section>

  <!-- Feedback -->
  <section id="feedback" class="home-section">
    <h2>Feedback</h2>
    <form id="feedback-form">
      <label for="stylistName">Stylist:</label>
      <select id="stylistName" required>
        <option value="">Loading stylists...</option>
      </select>

      <label for="rating">Rating (1 to 5):</label>
      <input type="number" id="rating" min="1" max="5" required />

      <label for="comments">Comments:</label>
      <textarea id="comments" required></textarea>

      <button type="submit">Submit Feedback</button>
    </form>
  </section>

  <!-- Notifications -->
  <section id="notifications" class="home-section">
    <h2>Notifications</h2>
    <ul id="notifications-list">
      <!-- dynamically loaded notifications -->
    </ul>
  </section>

  <!-- Help -->
  <section id="help" class="home-section">
    <h2>Help & FAQs</h2>
    <div>
      <h3>How to book an appointment?</h3>
      <p>Choose a service, select a stylist, pick a date and time, then click 'Book Appointment'.</p>
      
      <h3>How to reschedule?</h3>
      <p>Click 'Reschedule' in your appointment list and select a new date/time.</p>
      
      <h3>Troubleshooting?</h3>
      <p>Contact support@princesssalon.com or call 123-456-7890.</p>
    </div>
  </section>

  <script>
    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    const appointmentsTable = document.getElementById('appointments-table');
    let rescheduleId = null;

    function openRescheduleModal(id, currentDate, currentTime) {
      rescheduleId = id;
      document.getElementById('reschedule-date').value = currentDate;
      document.getElementById('reschedule-time').value = currentTime;
      document.getElementById('reschedule-modal').style.display = 'block';
    }

    function closeRescheduleModal() {
      document.getElementById('reschedule-modal').style.display = 'none';
      rescheduleId = null;
    }

    // Logout helper used by header/sidebar logout links
    function logout() {
      try { localStorage.removeItem('loggedInUser'); } catch (e) { /* ignore */ }
      // Redirect to the login/register page
      window.location.href = 'loginRegister.html';
    }

async function loadAppointments() {
  try {
    const res = await fetch(`/api/user-appointments/${user.id}`);
    const result = await res.json();
    if (result.success) {
      appointmentsTable.innerHTML = '';

    // Filter only Approved or Rescheduled (case-insensitive)
    const filteredAppointments = result.appointments.filter(app => {
      const status = app.status?.trim().toLowerCase();
      return status === 'approved' || status === 'rescheduled' || status === 'pending';
    });

      filteredAppointments.forEach(app => {
        const tr = document.createElement('tr');
        const formattedDate = new Date(app.date).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        const [hours, minutes] = app.time.split(":");
        const timeObj = new Date();
        timeObj.setHours(hours, minutes);
        const formattedTime = timeObj.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });

        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td>${formattedTime}</td>
          <td>${app.service}</td>
          <td>${app.stylist}</td>
          <td>${app.status}</td>
          <td>
            <button onclick="openRescheduleModal(${app.id}, '${app.date}', '${app.time}')">Reschedule</button>
            <button onclick="cancelAppointment(${app.id})">Cancel</button>
          </td>
        `;
        appointmentsTable.appendChild(tr);
      });
    }
  } catch (err) {
    console.error(err);
  }
}


    async function confirmReschedule() {
      const newDate = document.getElementById('reschedule-date').value;
      const newTime = document.getElementById('reschedule-time').value;
      if (!rescheduleId || !newDate || !newTime) return alert('Please fill out both fields.');
      try {
        const res = await fetch(`/api/reschedule-appointment/${rescheduleId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: newDate, time: newTime })
        });
        const result = await res.json();
        if (result.success) {
          alert('Appointment rescheduled.');
          closeRescheduleModal();
          loadAppointments();
          updateDashboardSummary();
          window.location.reload();
        } else alert('Failed to reschedule.');
      } catch (err) { console.error(err); alert('Error rescheduling appointment.'); }
    }

    async function cancelAppointment(id) {
      if (!confirm('Cancel this appointment?')) return;
      try {
        const res = await fetch(`/api/cancel-appointment/${id}`, { method: 'PATCH' });
        const result = await res.json();
        if (result.success) {
          alert('Appointment cancelled.');
          loadAppointments();
          updateDashboardSummary();
          window.location.reload();
        } else alert('Failed to cancel.');
      } catch (err) { console.error(err); alert('Error cancelling appointment.'); }
    }

    async function loadStylists() {
      const stylistSelect = document.getElementById('stylist');
      const feedbackStylistSelect = document.getElementById('stylistName');
      if (stylistSelect) stylistSelect.innerHTML = '<option value="">Loading stylists...</option>';
      if (feedbackStylistSelect) feedbackStylistSelect.innerHTML = '<option value="">Loading stylists...</option>';
      try {
        const res = await fetch('/api/stylists');
        const result = await res.json();
        if (result && result.success && Array.isArray(result.stylists)) {
          if (stylistSelect) stylistSelect.innerHTML = '<option value="">Select a Stylist</option>';
          if (feedbackStylistSelect) feedbackStylistSelect.innerHTML = '<option value="">Select a Stylist</option>';
          result.stylists.forEach(stylist => {
            const option1 = document.createElement('option');
            option1.value = stylist.name;
            option1.textContent = stylist.name;
            if (stylistSelect) stylistSelect.appendChild(option1);
            if (feedbackStylistSelect) {
              const option2 = option1.cloneNode(true);
              feedbackStylistSelect.appendChild(option2);
            }
          });
        } else {
          // Fallback: small static list so the UI remains usable
          const fallback = ['gab','lumaad','Test Stylist'];
          if (stylistSelect) {
            stylistSelect.innerHTML = '<option value="">Select a Stylist</option>';
            fallback.forEach(name => {
              const opt = document.createElement('option'); opt.value = name; opt.textContent = name; stylistSelect.appendChild(opt);
            });
          }
          if (feedbackStylistSelect) {
            feedbackStylistSelect.innerHTML = '<option value="">Select a Stylist</option>';
            fallback.forEach(name => {
              const opt = document.createElement('option'); opt.value = name; opt.textContent = name; feedbackStylistSelect.appendChild(opt);
            });
          }
        }
      } catch (err) { console.error(err); stylistSelect.innerHTML = feedbackStylistSelect.innerHTML = '<option value="">Error loading stylists</option>'; }
    }

 /* async function loadNotifications() {
    try {
      const response = await fetch('/api/notifications');
      const data = await response.json();

      if (data.success) {
        const list = document.getElementById('notifications-list');
        list.innerHTML = ''; // clear old notifications

        if (data.notifications.length === 0) {
          list.innerHTML = '<li>No notifications yet.</li>';
          return;
        }

        // Add each notification
        data.notifications.forEach(notif => {
          const li = document.createElement('li');
          li.textContent = ` ${notif.message}`;
          list.appendChild(li);
        });
      } else {
        console.error('Failed to load notifications:', data.message);
      }
    } catch (err) {
      console.error('Error fetching notifications:', err);
    }
  }
*/
  // Load notifications on page load

  async function loadNotifications() {
  try {
    // Get the logged-in user
    const user = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!user || !user.id) {
      console.warn('No logged-in user found.');
      return;
    }

    // Fetch notifications using the user ID as a param
    const response = await fetch(`/api/notificationss/${user.id}`);
    const data = await response.json();

    if (data.success) {
      const list = document.getElementById('notifications-list');
      list.innerHTML = ''; // clear old notifications

      if (data.notifications.length === 0) {
        list.innerHTML = '<li>No notifications yet.</li>';
        return;
      }

      // Add each notification
      data.notifications.forEach(notif => {
        const li = document.createElement('li');
        li.textContent = `${notif.message}`;
        list.appendChild(li);
      });
    } else {
      console.error('Failed to load notifications:', data.message);
    }
  } catch (err) {
    console.error('Error fetching notifications:', err);
  }
}

    async function updateDashboardSummary() {
      const res = await fetch(`/api/user-appointments/${user.id}`);
      const result = await res.json();
            console.log(result);
      if (result.success) {
        const appointments = result.appointments;
        document.getElementById('upcoming-count').textContent = appointments.filter(a => a.status === 'Approved').length;
        document.getElementById('completed-count').textContent = appointments.filter(a => a.status === 'Completed').length;
        document.getElementById('canceled-count').textContent = appointments.filter(a => a.status === 'Cancelled').length;
        // Favorite stylist: pick the stylist with most bookings
        const stylistCounts = {};
        appointments.forEach(a => { stylistCounts[a.stylist] = (stylistCounts[a.stylist] || 0) + 1; });
        const favorite = Object.entries(stylistCounts).sort((a,b) => b[1]-a[1])[0];
        document.getElementById('favorite-stylist').textContent = favorite ? favorite[0] : '-';
      }
    }

    document.getElementById('book-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      // Collect selected services (checkboxes)
      const serviceCheckboxes = document.querySelectorAll('#services-list input[name="services"]:checked');
      const services = Array.from(serviceCheckboxes).map(cb => cb.value);
      const service = services.length === 1 ? services[0] : null; // keep legacy single-service variable optional
      const stylist = document.getElementById('stylist').value;
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      if (!services || services.length === 0) return alert('Please select at least one service.');
      try {
        const res = await fetch('/api/book-appointment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // send services array; backend will accept array or legacy single service
          body: JSON.stringify({ userId: user.id, services, service, stylist, date, time })
        });
        const result = await res.json();
        if (result.success) {
          alert('Appointment booked!');
          loadAppointments();
          updateDashboardSummary();
          this.reset();
          // Reset time availability display
          document.getElementById('time').innerHTML = '<option value="">Select a Time</option>';
        } else alert(result.message || 'Booking failed.');
      } catch (err) { console.error(err); alert('Error booking appointment.'); }
    });

    // Add event listeners to block unavailable times
    const stylistSelect = document.getElementById('stylist');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');

    async function updateAvailableTimes() {
      const selectedStylist = stylistSelect.value;
      const selectedDate = dateInput.value;

      // Reset time input if either stylist or date is not selected
      if (!selectedStylist || !selectedDate) {
        timeInput.innerHTML = '<option value="">Select a Time</option>';
        timeInput.disabled = true;
        return;
      }

      timeInput.disabled = false;

      try {
        // Fetch booked times for the selected stylist and date
        const res = await fetch(`/api/booked-times/${encodeURIComponent(selectedStylist)}/${encodeURIComponent(selectedDate)}`);
        const result = await res.json();
        
        const bookedTimes = result.success ? result.bookedTimes : [];
        
        // Generate time options (30-minute intervals)
        const timeOptions = [];
        for (let hour = 9; hour < 18; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
            const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            timeOptions.push(timeStr);
          }
        }

        // Rebuild time select with disabled options for booked times
        timeInput.innerHTML = '<option value="">Select a Time</option>';
        timeOptions.forEach(timeStr => {
          const option = document.createElement('option');
          option.value = timeStr;
          option.textContent = new Date(`2024-01-01T${timeStr}`).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
          
          // Disable if this time is booked
          if (bookedTimes.includes(timeStr)) {
            option.disabled = true;
            option.style.color = '#ccc';
            option.textContent += ' (Booked)';
          }
          
          timeInput.appendChild(option);
        });
      } catch (err) {
        console.error('Error fetching booked times:', err);
      }
    }

    // Update available times when stylist or date changes
    stylistSelect.addEventListener('change', updateAvailableTimes);
    dateInput.addEventListener('change', updateAvailableTimes);

    document.getElementById('feedback-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const stylist = document.getElementById('stylistName').value;
      const rating = document.getElementById('rating').value;
      const comments = document.getElementById('comments').value;
      try {
        const res = await fetch('/api/submit-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, stylist, rating, comments })
        });
        const result = await res.json();
        if (result.success) {
          alert('Feedback submitted. Thank you!');
          this.reset();
        } else alert(result.message || 'Failed to submit feedback.');
      } catch (err) { console.error(err); alert('Error submitting feedback.'); }
    });

    document.getElementById('profile-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      try {
        const res = await fetch(`/api/update-profile/${user.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone })
        });
        const result = await res.json();
        if (result.success) {
          alert('Profile updated.');
          user.name = name;
          user.email = email;
          user.phone = phone;
          localStorage.setItem('loggedInUser', JSON.stringify(user));
        } else alert(result.message || 'Update failed.');
      } catch (err) { console.error(err); alert('Error updating profile.'); }
    });

    document.getElementById('password-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      try {
        const res = await fetch(`/api/change-password/${user.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const result = await res.json();
        if (result.success) {
          alert('Password changed.');
          this.reset();
        } else alert(result.message || 'Failed to change password.');
      } catch (err) { console.error(err); alert('Error changing password.'); }
    });

    async function loadServicesForBooking() {
      const container = document.getElementById('services-list');
      // Hardcoded service list as requested
      const services = [
        { id: 1, name: 'Haircut', price: 200, duration: 30 },
        { id: 2, name: 'Hair Color', price: 200, duration: 30 },
        { id: 3, name: 'Hair Rebond', price: 200, duration: 30 },
        { id: 4, name: 'Facial', price: 200, duration: 30 },
        { id: 5, name: 'Make up', price: 200, duration: 30 },
        { id: 6, name: 'Manicure', price: 200, duration: 30 },
        { id: 7, name: 'Pedicure', price: 200, duration: 30 }
      ];

      // populate items area
      const items = container.querySelector('.ms-items');
      const searchInput = container.querySelector('.ms-search');
      const control = container.querySelector('.ms-control');
      const dropdown = container.querySelector('.ms-dropdown');
      if (!items) return; // nothing to render into
      items.innerHTML = '';

      services.forEach(s => {
        const id = `service_cb_${s.id}`;
        const item = document.createElement('div');
        item.className = 'ms-item';
        item.innerHTML = `
          <div class="left">
            <label for="${id}">
              <input type="checkbox" id="${id}" name="services" value="${s.name}">
              <span class="name">${s.name}</span>
            </label>
          </div>
          <div class="meta">₱${s.price} • ${s.duration}m</div>
        `;
        items.appendChild(item);
      });

      // helper to update control text based on selection
      function updateControl() {
        const checked = container.querySelectorAll('input[name="services"]:checked');
        if (!checked || checked.length === 0) {
          control.textContent = 'Select services';
        } else if (checked.length <= 3) {
          const names = Array.from(checked).map(c => c.value);
          control.textContent = names.join(', ');
        } else {
          control.textContent = `${checked.length} services selected`;
        }
      }

      // attach change listeners
      items.querySelectorAll('input[name="services"]').forEach(cb => cb.addEventListener('change', updateControl));

      // filtering
      searchInput.value = '';
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim().toLowerCase();
        items.querySelectorAll('.ms-item').forEach(it => {
          const name = it.querySelector('.name')?.textContent?.toLowerCase() || '';
          it.style.display = name.includes(q) ? '' : 'none';
        });
      });

      // control open/close
      control.addEventListener('click', (e) => {
        const open = dropdown.classList.toggle('show');
        control.setAttribute('aria-expanded', open ? 'true' : 'false');
        dropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
        if (open) searchInput.focus();
      });

      // close when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          dropdown.classList.remove('show');
          control.setAttribute('aria-expanded', 'false');
          dropdown.setAttribute('aria-hidden', 'true');
        }
      });

      // initial update
      updateControl();
    }

    // Load favorite stylists dynamically

    // Load favorite stylists dynamically
    async function loadFavoriteStylists() {
      try {
        const res = await fetch(`/api/user-favorite-stylists/${user.id}`);
        const result = await res.json();
        const list = document.getElementById('favorite-stylist-list');
        list.innerHTML = '';
        if (result.success && result.stylists.length) {
          result.stylists.forEach(stylist => {
            const li = document.createElement('li');
            li.textContent = stylist.name;
            const unfollowBtn = document.createElement('button');
            unfollowBtn.textContent = 'Unfollow';
            unfollowBtn.onclick = async () => {
              await fetch(`/api/unfollow-stylist/${user.id}/${stylist.id}`, { method: 'DELETE' });
              loadFavoriteStylists();
            };
            li.appendChild(unfollowBtn);
            list.appendChild(li);
          });
        } else {
          list.innerHTML = '<li>No favorite stylists yet.</li>';
        }
      } catch (err) { console.error(err); }
    }

    // Call to load favorite stylists on page load
    window.addEventListener('DOMContentLoaded', loadFavoriteStylists);

async function loadBookingHistory() {
  try {
    const res = await fetch(`/api/user-appointments/${user.id}`);
    const result = await res.json();
    const historyTable = document.getElementById('booking-history-table');

    if (result.success) {
      historyTable.innerHTML = '';

      if (result.appointments.length === 0) {
        historyTable.innerHTML = '<tr><td colspan="5">No bookings yet.</td></tr>';
        return;
      }

      result.appointments.forEach(app => {
        const formattedDate = new Date(app.date).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        const [hours, minutes] = app.time.split(":");
        const timeObj = new Date();
        timeObj.setHours(hours, minutes);
        const formattedTime = timeObj.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td>${formattedTime}</td>
          <td>${app.service}</td>
          <td>${app.stylist}</td>
          <td>${app.status}</td>
        `;
        historyTable.appendChild(tr);
      });
    }
  } catch (err) {
    console.error('Error loading booking history:', err);
  }
}
    // Call it on dashboard load
    window.addEventListener('DOMContentLoaded', loadBookingHistory);

    // Main initializer: set welcome text, populate profile and load data
    window.addEventListener('DOMContentLoaded', () => {
      if (!user) return (window.location.href = 'loginRegister.html');
      // Set welcome text
      const wt = document.getElementById('welcome-text'); if (wt) wt.textContent = `Welcome, ${user.name}!`;
      // Populate profile fields
      const nameInput = document.getElementById('name'); if (nameInput) nameInput.value = user.name || '';
      const emailInput = document.getElementById('email'); if (emailInput) emailInput.value = user.email || '';
      const phoneInput = document.getElementById('phone'); if (phoneInput) phoneInput.value = user.phone || '';

      // Load data
      loadAppointments();
      loadStylists();
      loadNotifications();
      updateDashboardSummary();
      loadServicesForBooking();
    });
  </script>

<script>
  const hamburger = document.getElementById('hamburger');
  const sideNav = document.getElementById('sideNav');
  const closeSide = document.getElementById('closeSide');
  const backdrop = document.getElementById('backdrop');
  const navLinks = document.querySelectorAll('.side-links a');

  // Open sidebar
  hamburger.addEventListener('click', () => {
    sideNav.classList.add('open');
    backdrop.classList.add('show');
  });

  // Close sidebar
  const closeNav = () => {
    sideNav.classList.remove('open');
    backdrop.classList.remove('show');
  };

  closeSide.addEventListener('click', closeNav);
  backdrop.addEventListener('click', closeNav);

  // Automatically close when a link is clicked
  navLinks.forEach(link => {
    link.addEventListener('click', closeNav);
  });
</script>

</body>
</html>
